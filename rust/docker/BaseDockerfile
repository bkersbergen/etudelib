FROM pytorch/pytorch:2.0.0-cuda11.7-cudnn8-devel AS builder

WORKDIR /usr/src/devel

RUN set -eux; \
    apt-get update; \
    apt-get upgrade -y; \
    apt-get install -y --no-install-recommends \
    libssl-dev \
    pkg-config \
    musl-tools \
    curl \
	llvm \
    clang \
    bc;

COPY ./src src
COPY ./Cargo.toml ./

RUN curl https://sh.rustup.rs -sSf | bash -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
#RUN cargo search
# We need 5GB for each compile job otherwise we get OOM

# Determine number of jobs based on the available memory (GB)
RUN gb_per_job=4 && total_memory=$(free -b | awk '/Mem:/{print $2}') \
    && jobs=$(echo "scale=0; (${total_memory} + 1024^3/2) / 1024^3/${gb_per_job}" | bc) \
    && cargo build -j "${jobs}" --bin serving


#FROM pytorch/pytorch:2.0.0-cuda11.7-cudnn8-devel AS runtime
#RUN set -eux; \
#    apt-get update; \
#    apt-get upgrade -y;
#
#WORKDIR /app
#COPY --from=builder /usr/src/devel/target/release/serving /app
#COPY --from=builder /usr/src/devel/target/release/libonnxruntime* /app
